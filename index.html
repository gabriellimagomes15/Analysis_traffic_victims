<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Traffic Victims Analysis</title>
  <script src="http://code.jquery.com/jquery-3.2.1.js"></script>
  <script src="http://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

  <script type="text/javascript" src='js/d3.min.js'></script>
  <script type="text/javascript" src='js/functions.js'></script>
  <script type="text/javascript" src='js/d3ScaleColor.js'></script>
  <script type="text/javascript" src='js/cloud.js'></script> 
  <script type="text/javascript" src='js/bootstrap/bootstrap.min.js'></script> 

  <script type="text/javascript" src='js/charts.js'></script>
  
  <script src="https://use.fontawesome.com/e6b4ddaa2c.js"></script>

  <link href="vendor/datatables/dataTables.bootstrap4.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="css/charts.css">
  <link rel="stylesheet" type="text/css" href="css/custom.css">
  <link href="css/sb-admin.css" rel="stylesheet">
  <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

  <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

  <link href="vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

  <script type="text/javascript" src='js/highcharts.js'></script>

  <script src="https://code.highcharts.com/maps/modules/map.js"></script>
  <script src="https://code.highcharts.com/maps/modules/exporting.js"></script>
  <script src="https://code.highcharts.com/maps/modules/offline-exporting.js"></script>
  <script src="https://code.highcharts.com/mapdata/countries/br/br-all.js"></script>

  <script src="https://code.highcharts.com/modules/data.js"></script>


</head>
<body class="fixed-nav sticky-footer bg-dark" id="page-top" >
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top" id="mainNav">
    <a class="navbar-brand" href="index.html">Home</a>
    <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="navbar-collapse collapse " id="navbarResponsive">
      <ul class="navbar-nav navbar-sidenav" id="exampleAccordion">
        <li class="nav-item" data-toggle="tooltip" data-placement="right" title="Home">
          <a class="nav-link" href="#initial" data-toggle="tab">
            <i class="fa fa-fw fa-home"></i>
            <span class="nav-link-text">Home</span>
          </a>
        </li>
        <li class="nav-item" data-toggle="tooltip" data-placement="right" title="Dashboard">
          <a id='menudataviz' class="nav-link" href="#dataviz" data-toggle="tab">
            <i class="fa fa-fw fa-dashboard"></i>
            <span class="nav-link-text">Dashboard</span>
          </a>
        </li>
        <li class="nav-item" data-toggle="tooltip" data-placement="right" title="About">
          <a class="nav-link" href="#about" data-toggle="tab">
            <i class="fa fa-fw fa-info"></i>
            <span class="nav-link-text">About</span>
          </a>
        </li>
        <li class="nav-item" data-toggle="tooltip" data-placement="right" title="Contact">
          <a class="nav-link" href="#contact" data-toggle="tab">
            <i class="fa fa-fw fa-pencil"></i>
            <span class="nav-link-text">Contact</span>
          </a>
        </li>
      </ul>
      <ul class="navbar-nav sidenav-toggler">
        <li class="nav-item">
          <a class="nav-link text-center" id="sidenavToggler">
            <i class="fa fa-fw fa-angle-left"></i>
          </a>
        </li>
      </ul>
      <ul class="navbar-nav ml-auto">
        <li class="nav-item">
          <a href="https://github.com/gabriellimagomes15"  target="_blank"
         class="header-logo-invertocat my-0" style="padding: 5px 10px" data-toggle="tooltip" 
         data-placement="bottom" title="GitHub!" >
            <svg aria-hidden="true" class="octicon octicon-mark-github" style="fill: #fff;"
              height="30" version="1.1" viewBox="0 0 16 16" width="32">
              <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
            </svg>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-toggle="modal" data-target="#exampleModal">
            <i class="fa fa-fw fa-sign-out"></i>Logout</a>
        </li>
      </ul>
    </div>
  </nav>
  <div class="content-wrapper tab-content">
    <div id='initial' class="container-fluid tab-pane fade in active " role="tabpanel">
      <div class="jumbotron container">
          <div class="col-md-10">
            <h1>Análise de Vítimas no Trânsito</h1>
          </div>
          <div class="col-md-10">
            <p> Uma aplicação para realizar análises das vítimias em acidentes de trânsito em rodovias do Brasil.</p>
            
            <div class="alert alert-success">
              <p><strong> <span class='numbjobs'> Mais de 3 MILHÕES de dados </span></strong></p>              
            </div>
          </div>
      </div>
    </div>

    <div id='dataviz' class="container-fluid tab-pane fade  " role="tabpanel">
      <!-- Breadcrumbs-->
      <ol class="breadcrumb">
        <li class="breadcrumb-item active">Dashboard Vítimas Acidentes </li>
      </ol>
      <!-- Boxes Informations -->
      <div class="row">
        <div class="col-xl-4 col-sm-6 mb-3">
          <div class="card text-white bg-primary o-hidden h-70">
            <div class="card-body boxone">
              <div class="card-body-icon">
                <i class="fa fa-fw fa-database"></i>
              </div>
              <div id='boxnumber' class="mr-5"></div>
            </div>
          </div>
        </div>
        <div class="col-xl-4 col-sm-6 mb-3">
          <div class="card text-white bg-warning h-70">
            <div class="card-body boxtwo">
              <div class="card-body-icon">
                <i class="fa fa-fw fa-globe"></i>
              </div>
              <div id='boxnumbertwo' class="mr-5"></div>
            </div>
            <div class="dropdown" style="">
                <select id='selcountry' class="selectpicker bg-warning text-white" style="width: 100%">
                  <option value="todos"> Todos </option>
                </select>
            </div>
          </div>
        </div>
        <div class="col-xl-4 col-sm-6 mb-3">
          <div class="card text-white bg-success o-hidden h-70">
            <div class="card-body boxthird">
              <div class="card-body-icon">
                <i class="fa fa-fw fa-location-arrow"></i>
              </div>
              <div id='boxnumberthird' class="mr-5"></div>
            </div>
          </div>
        </div>
        
      </div>

      <!--div class="row">
        
        <div class="col-xl-4 col-sm-6 mb-3">
          <div class="card text-black bg-muted o-hidden h-70">
            <div class="card-body boxthird">
              <div class="mr-5"> <b> Estado Físico </b> </div>
              <div id="inputs" class="custom-control-label">  </div>
            </div>
          </div>
        </div>
        <div class="col-xl-4 col-sm-6 mb-3">
          <div class="card text-black bg-muted o-hidden h-70">
            <div class="card-body boxthird">
              <div class="mr-5"> Anos </div>
              <div id="inputs" class="custom-control-label">  </div>
            </div>
          </div>
        </div>
      </div-->
        
      

      <div class="row">
        <div class="col-lg-8">        
          <div class="card mb-3">
            <div class="card-header">
              <i class="fa fa-line-chart"></i> Vítimas por Data</div>
            <div id='vitData' class="card-body" ></div>
            <div class="card-footer small text-muted">Updated in <span></span></div>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="card mb-3">
            <div class="card-header"><i class="fa fa-map"></i> Média Idade das Vítimas por Estado </div>
            <div id='vitIdade' class="card-body col-sm-12 my-auto" ></div>
            <div class="card-footer small text-muted">Updated in <span></span></div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-lg-4">
          <div class="card mb-3">
            <div class="card-header"><i class="fa fa-map"></i>  Qtd. Vítimas por Estado </div>
            <div id='vitEstado' class="card-body col-sm-12 my-auto" ></div>
            <div class="card-footer small text-muted">Updated in <span></span></div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card mb-3">
            <div class="card-header">
              <i class="fa fa-pie-chart"></i> Estado Físico Vítimas </div>
            <div id='vitFisico' class="card-body"></div>
            <div class="card-footer small text-muted">Updated in <span></span></div>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="card mb-3">
            <div class="card-header"><i class="fa fa-map"></i> Sexo Vítimas por Estado </div>
            <div id='vitSexEst' class="card-body col-sm-12 my-auto" ></div>
            <div class="card-footer small text-muted">Updated in <span></span></div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-lg-8">
          <div class="card mb-3">
            <div class="card-header">
              <i class="fa fa-line-chart"></i> Sexo das Vítimas por Data</div>
            <div id='d' class="card-body" ></div>
            <div class="card-footer small text-muted">Updated in <span></span></div>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="card mb-3">
            <div class="card-header">
              <i class="fa fa-pie-chart"></i> Sexo Vítimas</div>
            <div id='vitSexo' class="card-body"></div>
            <div class="card-footer small text-muted">Updated in <span></span></div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-lg-6">
          <div class="card mb-3">
            <div class="card-header">
              <i class="fa fa-bar-chart"></i> Vítimas por Idade e Sexo</div>
            <div id='piramide' class="card-body"></div>
            <div class="card-footer small text-muted">Updated in <span></span></div>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="card mb-3">
            <div class="card-header">
              <i class="fa fa-bar-chart"></i> Estado Físico das Vítimas por Sexo</div>
            <div id='estado_sexo' class="card-body" ></div>
            <div class="card-footer small text-muted">Updated in <span></span></div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-lg-8">
          <div class="card mb-3">
            <div class="card-header">
              <i class="fa fa-bar-chart"></i> Causas de Acidentes por Ano (Qtd. vítimas) </div>
            <div id='causaAcidAno' class="card-body"></div>
            <div class="card-footer small text-muted">Updated in <span></span></div>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="card mb-3">
            <div class="card-header">
              <i class="fa fa-pie-chart"></i> Causas de acidentes (Qtd. vítimas) </div>
            <div id='causaAcidente' class="card-body"></div>
            <div class="card-footer small text-muted">Updated in <span></span></div>
          </div>
        </div>

      </div>

    </div> <!-- FIM DIV dataviz-->
    
    <div id='about' class="container-fluid tab-pane fade " role="tabpanel">
      <div class="container jumbotron">
        <div class="col-md-12">
          <h1>About</h1>
        </div>
        <div class="col-md 10">
          <p>
            Uma aplicação para realizar análises das vítimias em acidentes de trânsito em rodovias do Brasil.
          </p>
          <p>
            Os dados foram coletados da plataforma de <a href='https://www.prf.gov.br/portal/dados-abertos'> dados abertos da PRF</a>
          </p>
        </div>
      </div>
    </div>

    <div id='contact' class="container-fluid tab-pane fade " role="tabpanel">
        <div class="jumbotron container">
          <div class="row">
            <div class="col-md-10">
              <h1>Contact me</h1>
            </div>
            <div class="col-md-10">
              <h3><b>Email:</b></h3> 
              <h4>gabriel.lg08@gmail.com</h4>
            </div>
            <div class="col-md-10">
              <h3><b>Phone</b></h3> 
              <h4>+55 61 985094857</h4>
            </div>
            <div class="col-sm-6">
              <a href="https://github.com/gabriellimagomes15">
                  <img style="width:50%;margin-left: -1em;" 
                  src="img/github.png"/>
              </a>
            </div>
            <div class="col-sm-6">
              <a href="https://www.linkedin.com/in/gabriellimagomes/">
                <img style="width:15%" 
                  src="img/linkedin.png"/>
                </a>
            </div>
          </div>
        </div>
    </div>

    <footer class="sticky-footer">
      <div class="container">
        <div class="text-center">
          <small>Copyright © Gabriel Lima Gomes 2018</small>
        </div>
      </div>
    </footer>
    <a class="scroll-to-top rounded" href="#page-top" style="display: inline;">
      <i class="fa fa-angle-up"></i>
    </a>

<script>
    
  
  // FUNÇÃO PARA MONSTAR OS GRÁFICOS AO SELECIONAR O MENU 'DASHBOARDS'
  $('#menudataviz').on('click',function(e){
      
      var path_data = ["data/dados_p5.csv"];      
      //var path_data = ["data/dados_p1.csv","data/dados_p2.csv","data/dados_p3.csv","data/dados_p4.csv", "data/dados_p5.csv"];

      var async_request=[];
      var responses=[];
      for(i in path_data)
      {
          console.log(path_data[i],i)
          // you can push  any aysnc method handler
          async_request.push($.ajax({
              url:  path_data[i],//'', // your url
              method:'get', // method GET or POST
              success: function(data){
              
                  var csvval = data.split("\n");
                  var jsonObj = [];
                  var headers  = csvval[0].split(",");

                  for(var i = 1; i < csvval.length-1; i++){
                      var colunas = csvval[i].split(',');
                      var obj = {};
                      
                      for(var j = 1; j < colunas.length; j++) {
                          obj[headers[j].trim()] = colunas[j].trim();
                      }
                      jsonObj.push(obj);
                  }
                  var jsonData = JSON.stringify(jsonObj);

                  jsonObj.map(function(x){ 
                    responses.push(x); 
                  })
                  console.log('success of ajax response')
              }
          }));
      }
      $.when.apply(null, async_request).done( function(){
          // all done
          console.log('all request completed')
          //console.log(responses);
          plots(responses)
      });      
  })

function plots(data){
      data.map(function(x){
        x.mesAno = x.ano + '-' + x.mes  
      })

      d3.select('#boxnumber').text( data.length.toLocaleString('de-DE') + ' vítimas')
      
      ano = group(data,['ano'])
      d3.select('#boxnumbertwo').text( 'Média de ' + d3.mean(ano,function(d) { return +d.count}).toLocaleString('de-DE') + ' vítimas ao ano')        

      mes = group(data,['mesAno'])
      
      d3.select('#boxnumberthird').text( 'Média de ' + d3.mean(mes,function(d) { return +d.count}).toLocaleString('de-DE') + ' vítimas ao mês')

/* BLOCO PARA FUTURA IMPLEMENTAÇÃO PARA DEIXAR O GRÁFICO MAIS DINAMICO E PERSONALIZADO
DE ACORDO COM A NECESSIDADE DO USUÁRIO
      g = group(data,['estado_fisico'])
    
      g.map(function(x){
          var chk = document.createElement('input');  // CREATE CHECK BOX.
          chk.setAttribute('type', 'checkbox');       // SPECIFY THE TYPE OF ELEMENT.
          chk.setAttribute('id', 'prodName' + x.value);     // SET UNIQUE ID.
          chk.setAttribute('value', x.value);
          chk.setAttribute('name', 'products');
          //chk.setAttribute('class', 'custom-control-input');


          var lbl = document.createElement('label');  // CREATE LABEL.
          lbl.setAttribute('for', ' prodName' + x.value);
          //lbl.setAttribute('class', 'custom-control-label');


          // CREATE A TEXT NODE AND APPEND IT TO THE LABEL.
          lbl.appendChild(document.createTextNode(x.value));

          // APPEND THE NEWLY CREATED CHECKBOX AND LABEL TO THE <p> ELEMENT.
          container = document.getElementById('inputs')
          container.appendChild(chk);
          container.appendChild(lbl);

          //obj.value = '';
          //document.getElementById(obj.id).focus();

          //i = i + 1;        
      })

*/      

      groutDt = group(data, ['mesAno'])
      x = groutDt.map(function(x){  return [ Number(new Date(x.value)) ,x.count] })

      x.sort(function(x,y){
        return d3.descending(y[0],x[0])
      })
      vitimas_times('vitData',x)

      //============================================================================
      estado = group(data, ['uf'])
      estado = estado.filter(function(x) {return x.value != '(null)'})
      max    = d3.max(estado,function(d) { return +d.count}); 

      estado = JSON.parse(JSON.stringify(estado).split('"value":').join('"code":')); //ALTERAR NOME DOS ATRIBUTOS DO JSON
      estado = JSON.parse(JSON.stringify(estado).split('"count":').join('"value":'));//ALTERAR NOME DOS ATRIBUTOS DO JSON

      vit_estado('vitEstado',estado)

      //============================================================================

      sexoUf = group(data, ['sexo','uf'])
      mascUf = sexoUf.filter(function(x){ return x.value == 'Masculino' })[0]
      femUf  = sexoUf.filter(function(x){ return x.value == 'Feminino'})[0]
      lista  = []
      masc   = {name:'Masculino', color: 'blue', data:[]}
      fem    = {name:'Feminino', color: 'pink', data:[]}
      
      mascUf.values.map(function(m){
        femUf.values.map(function(f){
          if (m.value != '(null)' && m.value == f.value){
            if(m.count > f.count   ){
              masc.data.push({code:m.value,count:m.count})
            }else{
              fem.data.push({code:f.value,count:f.count})
            }
          }
        })
      })
      
      vit_sex_map('vitSexEst',fem,masc)

      //============================================================================
      
      idade    = data.filter(function(x){ return x.idade > -1})
      idadeEst = groupMetric(idade,'uf','idade')

      i = idadeEst.map(function(x){ return {code: x.value, value: x.count.avg} } )
      vit_idade_map('vitIdade',i)

      //============================================================================
      sexo = group(data, ['sexo'])
      pie_chart('vitSexo',sexo)

      //============================================================================

      fisico = group(data, ['estado_fisico'])
      pie_chart('vitFisico',fisico)
      
      //============================================================================
      groutDt = group(data, ['sexo','mesAno'])
      groutDt = groutDt.filter(function(x){ return x.value == 'Masculino' || x.value == 'Feminino' })
      xx = groutDt.map(function(x){  return {name: x.value, data: x.values.map(function(y){ 
                          return [ Number(new Date(y.value)) ,y.count] 
                        })
                      }
                    })
      
      xx.map(function(d){
        d.data.sort(function(x,y){
          return d3.descending(y[0],x[0])
        })
      }) 
      time_sexo('d',xx)
      
  //============================================================================
      qtdSexo = group(data,['sexo','catIdade'])
      a = []
      categories.map(function(c){
            qtdSexo.filter(function(x){ 
                                return x.value == 'Feminino' 
                              }).map(function(y){
                                  return y.values.map(function(z){
                                      if (z.value == c && z.value != '-1' ){
                                        a.push(z.count)
                                      }
                                  })
                                })
          })
      fem = {name: 'Feminino',data: a}

      a = []
      categories.map(function(c){
            qtdSexo.filter(function(x){ 
                                return x.value == 'Masculino' 
                              }).map(function(y){
                                  return y.values.map(function(z){
                                      if (z.value == c && z.value != '-1' ){
                                        a.push(-z.count)
                                      }
                                  })
                                })
          })
      masc  = {name: 'Masculino',data: a}
      lista = [fem, masc]

      piramide('piramide',lista)

  //============================================================================
      fisico_sexo = group(data.filter(function(x){return x.sexo == "Masculino" || x.sexo == "Feminino"}),['estado_fisico','sexo'])

      estado_fisico  = fisico_sexo.map(function(x){ return x.value }) //LISTA DE ESTADO FISICO 

      sexo = group(data.filter(function(x){return x.sexo == "Masculino" || x.sexo == "Feminino"}), ["sexo"]).map(function(x){ return x.value })

      fisico_sexo   = fisico_sexo.filter(function(x) {return estado_fisico.includes(x.value) })
      estado_fisico = estado_fisico.sort()

      fisico_sexo.sort(function(x,y){
        return d3.ascending(x.value,y.value)
      })

      g_estado_fisico = {}
      g_estado_fisico.categories = estado_fisico

      sexo.map(function(ano){
        fisico_sexo.map(function(causa){
          sub_anos = causa.values.map(function(x){
                        return x.value
                      })
          if(sub_anos.includes(ano)){
            qtd = causa.values.filter(function(x){ return x.value == ano}).map(function(y){ return y.count})[0]

            if(Object.keys(g_estado_fisico).includes(ano)){
              g_estado_fisico[ano].push(qtd)
            }else{
              g_estado_fisico[ano] = [qtd]
            }

          }else{
            if(Object.keys(g_estado_fisico).includes(ano)){
              g_estado_fisico[ano].push(0)
            }else{
              g_estado_fisico[ano] = [0]
            }
          }
        })
      })

      lista = []
      for(var p in g_estado_fisico){
        ob = {}
        ob[p] = g_estado_fisico[p]        
        lista.push(ob)
      }
      causa_acid_ano('estado_sexo',lista)

  //============================================================================
    causa_acidente = group(data,["causa_acidente"])
    causa_acidente = causa_acidente.filter(function(x){ return x.value != "outras"})
    causa_acidente.sort(function(x,y){
        return d3.descending(x.count,y.count)
    })
    causa_acidente = causa_acidente.slice(0,5)
    sexo = group(data, ['sexo'])

    pie_chart('causaAcidente',causa_acidente)

  //============================================================================
      causa_acidente_ano = group(data.filter(function(x){return x.causa_acidente != "outras" } ),['causa_acidente','ano'])

      causa_acidente = causa_acidente.map(function(x){ return x.value }) //LISTA DE CAUSA DE ACIDENTES
      anos = group(data, ["ano"]).map(function(x){ return x.value })
      causa_acidente_ano = causa_acidente_ano.filter(function(x) {return causa_acidente.includes(x.value) })
      
      causa_acidente = causa_acidente.sort()

      causa_acidente_ano.sort(function(x,y){
        return d3.ascending(x.value,y.value)
      })

      g_causa_acid = {}
      g_causa_acid.categories = causa_acidente
      
      anos.map(function(ano){
        causa_acidente_ano.map(function(causa){
          sub_anos = causa.values.map(function(x){
                        return x.value
                      })

          if(sub_anos.includes(ano)){
            qtd = causa.values.filter(function(x){ return x.value == ano}).map(function(y){ return y.count})[0]

            if(Object.keys(g_causa_acid).includes(ano)){
              g_causa_acid[ano].push(qtd)
            }else{
              g_causa_acid[ano] = [qtd]
            }

          }else{
            if(Object.keys(g_causa_acid).includes(ano)){
              g_causa_acid[ano].push(0)
            }else{
              g_causa_acid[ano] = [0]
            }
          }
        })
      })

      lista = []

      for(var p in g_causa_acid){
        ob = {}
        ob[p] = g_causa_acid[p]        
        lista.push(ob)
      }

      causa_acid_ano('causaAcidAno',lista)


}  // FIM FUNÇÃO PLOTS 


</script>
	</body>
</html>